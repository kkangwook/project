# í•œêµ­ ìŒì› audio_featureì‚¬ì´íŠ¸: TuneBat
 ë°ì´í„° ì¶œì²˜
Spotify Web API í™œìš©
ì‚¬ì´íŠ¸ëŠ” 70â€¯M+ ê³¡ì˜ í‚¤, BPM ë“±ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ Spotifyì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
Tunebat ìì²´ ë¶„ì„ ì™¸ì— ì´ Spotify ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì •ë³´ë„ í¬í•¨ 

Essentia.js ê¸°ë°˜ ë¸Œë¼ìš°ì € ë¶„ì„
íŒŒì¼ ì—…ë¡œë“œ ì‹œ ë¸Œë¼ìš°ì € ë‚´ì—ì„œ Essentia.js(ìŠ¤í˜ì¸ ë°”ë¥´ì…€ë¡œë‚˜ UPFì˜ Music Technology Group(MTG) ê°œë°œ)ë¥¼ ì‚¬ìš©í•´ ë¶„ì„í•©ë‹ˆë‹¤ 
Energy, danceability, happiness ë“± ML ê¸°ë°˜ ì¶”ì • ì§€í‘œëŠ” í•™ìŠµëœ ë¶„ì„ ëª¨ë¸ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤ 

âœ… ì‹ ë¢°ì„± í‰ê°€
í‚¤(BPM, Camelot key)
Spotify APIì—ì„œ ê°€ì ¸ì˜¤ë©°, Tunebat ë‚´ ë¶„ì„ê³¼ ë¹„êµí•´ ì œê³µë¨.
Spotify ë©”íƒ€ë°ì´í„°ëŠ” ì •í™•ë„ê°€ ê·¸ë¦¬ ë†’ì§€ ì•Šë‹¤ëŠ” ì§€ì ë„ ì¡´ì¬(<â€¯33% ì •í™•ë„) 
ë°˜ë©´ Tunebatì˜ ë¸Œë¼ìš°ì € ë¶„ì„ë„ â€œë‹¤ë¥¸ ìƒìš© í‚¤/BPM ë¶„ì„ë³´ë‹¤ ë” ë‚˜ì€ ê²½ìš°ë„ ìˆë‹¤â€ê³  ê³µì‹ ì–¸ê¸‰ 

Sentiment (energy/danceability/happiness)
ëª¨ë‘ ML ëª¨ë¸ë¡œ ì¶”ì •ëœ ê°’ì´ë©°, ì ˆëŒ€ì  ì§„ì‹¤ì´ë¼ê¸°ë³´ë‹¤ëŠ” â€˜ê³¡ íŠ¹ì„±ì˜ ìƒëŒ€ì  ë¶„ì„ ê²°ê³¼â€™ë¡œ ì´í•´í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤ 

ì»¤ë®¤ë‹ˆí‹°Â·ì „ë¬¸ê°€ ì˜ê²¬
Reddit / MP3Tag ë“±ì—ì„œ Tunebatì€ "ìœ ìš©í•˜ë‹¤"ì§€ë§Œ, ì •í™•ë„ ìµœìƒê¸‰ì´ë¼ê¸°ë³´ë‹¤ ì°¸ê³ ìš©ìœ¼ë¡œ ì‚¬ìš©ë¨ 

ğŸ§­ ì •ë¦¬
ì¶œì²˜: Spotify API + Essentia.js + ìì²´ ML ëª¨ë¸ ê¸°ë°˜ ë¶„ì„.
BPM/í‚¤: ë¹„êµì  ë¯¿ì„ ë§Œí•˜ì§€ë§Œ, Spotify ê¸°ë³¸ ë©”íƒ€ëŠ” ë¶€ì •í™•í•  ìˆ˜ ìˆìŒ (íŠ¹íˆ í‚¤ ì •ë³´).
í‘œì •ê°’ (energy ë“±): ì§€í‘œì  ì°¸ê³ ìš©ì´ë©°, ì ˆëŒ€ê°’ì´ ì•„ë‹˜.
ê²°ë¡ : â€œì •í™•í•œ ì‚¬ì´íŠ¸â€ë¼ê¸°ë³´ë‹¤ëŠ” ë¯¿ì„ ë§Œí•œ ì°¸ê³  ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤.



# ëª¨ë¸ ì •í™•ë„ ë†’íˆê¸°
-svmë„ ì‚¬ìš©í•´ë³´ê¸°
-cos-sin encodingë§ê³  oheë„ í•´ë³´ê¸°
-3ë…„ë‹¨ìœ„ë¡œ í•´ë³´ê¸°
-ì¥ë¥´ ìˆ«ìì„¸ì„œ ì¼ì •ê°œìˆ˜ ë¯¸ë§Œì¸ ì• ë“¤ì€ ì „ë¶€ ê¸°íƒ€ë¡œ ì¹˜í™˜í•˜ê³  ëª¨ë¸ë§Œì„ì–´ë³´ê¸°
-ê°€ì¤‘ì¹˜ ë‹¬ë¦¬í•´ì„œ í•´ë³´ê¸°
-3.5:6.5ì˜ í´ë˜ìŠ¤ê°œìˆ˜ ë¶ˆê· í˜•ìˆìŒ
scale_pos_weight = n_negative / n_positive = 850 / 450 â‰ˆ 1.89
XGBClassifier(..., scale_pos_weight=1.89)-> ì°¨íŠ¸ì¸ ì˜ˆì¸¡ì„ ë” ë¯¼ê°í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŒ


# ì¹´ë©œë¡¯, í‚¤ ì¤‘ ì¹´ë©œë¡¯ ì‚¬ìš©í•˜ëŠ”ê²Œ ì¢‹ì„ë“¯(ì¢€ë” ì‚¬ëŒì´ ë“£ëŠ” ë¶„ìœ„ê¸°ë‘ ë” ë¹„ìŠ·)
 # ì¹´ë©œë¡¯ ì¸ì½”ë”©ë°©ë²•: Embedding ë˜ëŠ” Sine/Cosine ì¸ì½”ë”© (ê¶Œì¥)
ì›í˜• ë°ì´í„°ë¥¼ ìˆ«ìë¡œ ì¸ì½”ë”©í•  ë•ŒëŠ” sin/cos ë³€í™˜ì´ ìµœì 
-> ì‹œê°„, ìš”ì¼, ë°©í–¥ë“±ì˜ ìˆœí™˜ ë°ì´í„°ì— ì‚¬ìš©
-> ì›í˜•ë°ì´í„°ë¥¼ ê°ë„ë¡œ ë°”ê¾¸ê³  ê·¸ ì‚¬ì¸/ì½”ì‚¬ì¸ ê°’ì„ 2ì°¨ì› ë²¡í„°ë¡œ ì¶”ê°€í•˜ëŠ”ê²ƒ
angle = 2Ï€ Ã— (ê°’ - 1) / 12
np.sin(angle)
np.cos(angle)
ì¶”í›„ feature_importanceì—ì„œ importance_camelot = importance_sin + importance_cos ì²˜ëŸ¼ í•©ì‚°í•˜ê¸°ë„ í•¨ 



--ê²€ì¦ìœ¼ë¡œ roc_auc_score()ì‚¬ìš©-> ì‹¤ë¬´ì—ì„œ ë” ì„ í˜¸


import numpy as np

camelot_number = 8   # 1~12
angle = 2 * np.pi * (camelot_number - 1) / 12
camelot_sin = np.sin(angle)
camelot_cos = np.cos(angle)

ê²°ê³¼:
camelot_sin â‰ˆ 0.866
camelot_cos â‰ˆ -0.5
â¡ï¸ ìµœì¢… í”¼ì³ ë²¡í„°: [camelot_sin, camelot_cos, camelot_mode] (3ì°¨ì›)

ì¥ì :

1Aì™€ 12Aê°€ ê°€ê¹ë‹¤ëŠ” ê±¸ ìˆ˜í•™ì ìœ¼ë¡œ í‘œí˜„ ê°€ëŠ¥

ì›í˜• êµ¬ì¡°ë¥¼ ìœ ì§€í•œ ì±„ ìˆ«ì ì¸ì½”ë”© ê°€ëŠ¥

ë§ì€ ì‹¤ì œ ëª¨ë¸ì—ì„œ ì‚¬ìš©ë˜ëŠ” ë°©ì‹ (ì‹œê°„, ê°ë„ ë“±ì—ì„œ)



-------------------------------------------------------------------------------------------
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import os
import time
import csv
from selenium.webdriver.chrome.options import Options
from selenium.common.exceptions import ElementClickInterceptedException
from selenium.webdriver.common.action_chains import ActionChains

# ë¡œë´‡ ë¬´ì‹œ ë° ê´‘ê³  ì°¨ë‹¨ ì„¤ì •
options = Options()
options.add_argument('--disable-blink-features=AutomationControlled')
options.add_argument('--disable-notifications')
options.add_argument('--disable-popup-blocking')
options.add_argument('--disable-infobars')
options.add_argument('--disable-gpu')
options.add_argument('--disable-extensions')
options.add_argument('--no-sandbox')
options.add_argument('--disable-dev-shm-usage')

# í¬ë¡¬ driver ìƒì„± 
driver_path = ChromeDriverManager().install()
correct_driver_path = os.path.join(os.path.dirname(driver_path), "chromedriver.exe")
driver = webdriver.Chrome(service=Service(executable_path=correct_driver_path), options=options)
driver.maximize_window()  # ì°½ ìµœëŒ€í™”

########################ì—¬ê¸°ì— ì§ˆë¬¸ ì‚½ì…#################################
year=2024
query = list_2024
########################################################################

f=open(f'./tunebat_{year}.csv','w',encoding='utf-8-sig',newline='')
writer=csv.writer(f)
title_row = ['artist','song','key','camelot','bpm','duration','popularity','energy','danceability','happiness','acousticness','instrumentalness','liveness','speechiness','loudness','year']
writer.writerow(title_row)

def click_element_safely(element, driver):
    """ìš”ì†Œë¥¼ ì•ˆì „í•˜ê²Œ í´ë¦­í•˜ëŠ” í•¨ìˆ˜"""
    try:
        # ì¼ë°˜ì ì¸ í´ë¦­ ì‹œë„
        element.click()
    except ElementClickInterceptedException:
        try:
            # JavaScriptë¡œ í´ë¦­ ì‹œë„
            driver.execute_script("arguments[0].click();", element)
        except:
            try:
                # Action chainsë¡œ í´ë¦­ ì‹œë„
                ActionChains(driver).move_to_element(element).click().perform()
            except:
                return False
    return True

# ëŒ€ìƒ url ì´ë™ 
driver.get('https://tunebat.com/')
time.sleep(7)

for i in query:
    try:
        # ê²€ìƒ‰ì°½ 
        box = WebDriverWait(driver, 10).until(
            EC.presence_of_element_located((By.XPATH, '/html/body/div[2]/section/section/main/div/form/div/span/input'))
        )
        box.clear()  # ì´ì „ ê²€ìƒ‰ ì§€ìš°ê¸°
        box.send_keys(i) # ê²€ìƒ‰ì°½ì— ì¿¼ë¦¬ë„£ê¸°
        box.send_keys(Keys.ENTER) #ì—”í„°
        
        # ê²€ìƒ‰ ê²°ê³¼ì˜ ì²« ë²ˆì§¸ í•­ëª© ëŒ€ê¸° ë° í´ë¦­
        btn = WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable((By.XPATH, '/html/body/div[2]/section/section/main/div/div[2]/div[2]/div[1]/a'))
        )
        
        # iframe ì œê±° ì‹œë„
        try:
            iframes = driver.find_elements(By.TAG_NAME, "iframe")
            for iframe in iframes:
                driver.execute_script("arguments[0].remove();", iframe)
        except:
            pass
        
        # ì•ˆì „í•œ í´ë¦­ ì‹œë„
        if not click_element_safely(btn, driver):
            print(f"Failed to click for query: {i}")
            # Write NaN values for failed click
            nan_row = ['NaN'] * (len(title_row) - 1) + [year]
            writer.writerow(nan_row)
            continue
            
        # ë°ì´í„° ìˆ˜ì§‘
        time.sleep(3)  # ë¡œë”© ëŒ€ê¸° ì‹œê°„ ì¦ê°€
        
        data1 = driver.find_elements(By.CLASS_NAME, 'ant-typography')
        lists = []
        k = 0
        prelists = []
        for item in data1:
            prelists.append(item.text)
            k += 1
            if k > 21: break
            print(k,item.text)
            
        if prelists[13].startswith('Label'):
            lists.extend([prelists[0],prelists[1],prelists[2],prelists[4],prelists[6],prelists[8]])
        else:
            lists.extend([prelists[0],prelists[1],prelists[2],prelists[4],prelists[6],prelists[8]])
            
        data2 = driver.find_elements(By.CLASS_NAME, 'ant-progress-text')
        for item in data2:
            lists.append(item.text)
            
        lists.append(year)
        print(lists)
        print(prelists)
        
        # Ensure the list has the correct number of elements
        if len(lists) < len(title_row):
            lists.extend(['NaN'] * (len(title_row) - len(lists)))
        writer.writerow(lists)
        
        # í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
        home = WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable((By.XPATH, '/html/body/div[2]/section/section/div[1]/div/div[1]/a'))
        )
        click_element_safely(home, driver)
        time.sleep(3)  # í™ˆí˜ì´ì§€ ë¡œë”©ì„ ìœ„í•œ ëŒ€ê¸° ì‹œê°„ ì¦ê°€
        
    except Exception as e:
        print(f"Error processing {i}: {str(e)}")
        # Write NaN values for all columns except year when an error occurs
        nan_row = ['NaN'] * (len(title_row) - 1) + [year]
        writer.writerow(nan_row)
        # ì—ëŸ¬ ë°œìƒì‹œ í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸° ì‹œë„
        try:
            driver.get('https://tunebat.com/')
            time.sleep(5)
        except:
            pass
        continue

driver.quit()
f.close()
